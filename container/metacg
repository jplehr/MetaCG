FROM registry.git.rwth-aachen.de/tuda-sc/projects/metacg/base:latest

WORKDIR /opt/metacg

RUN mkdir metacg && mkdir -p deps/install && cd deps && wget http://apps.fz-juelich.de/scalasca/releases/cube/4.5/dist/cubelib-4.5.tar.gz && mkdir cubelib && cd cubelib && tar xzf ../cubelib-4.5.tar.gz && cd cubelib-4.5 && ./configure --prefix=/opt/metacg/deps/install/cubelib && make -j $(nproc) && make install

COPY . /opt/metacg/metacg

RUN cd metacg && cd pgis && PATH=/opt/metacg/deps/install/cubelib/bin:$PATH ./build_submodules.sh $(nproc) && cd .. && mkdir build && cd build && cmake -DCMAKE_BUILD_TYPE=Debug -DCUBE_INCLUDE=/opt/metacg/deps/install/cubelib/include/cubelib -DCUBE_LIB=/opt/metacg/deps/install/cubelib/lib -DEXTRAP_INCLUDE=/opt/metacg/metacg/pgis/deps/src/extrap/extrap-3.0/include -DEXTRAP_LIB=/opt/metacg/metacg/pgis/deps/install/extrap/lib -DSPDLOG_BUILD_SHARED=ON -DCMAKE_VERBOSE_MAKEFILE:BOOL=ON .. && make -j $(nproc)
